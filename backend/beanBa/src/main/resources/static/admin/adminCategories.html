<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ—‚ï¸ ê´€ë¦¬ì ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        input, select {
            padding: 4px;
            margin: 2px;
        }
        #controls, #createForm {
            margin-top: 20px;
        }
        #createForm {
            border: 1px solid #ccc;
            padding: 15px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

<h1>ğŸ“‹ ì¹´í…Œê³ ë¦¬ ëª©ë¡</h1>
<button onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>

<!-- í˜ì´ì§€ ì¡°íšŒ ì»¨íŠ¸ë¡¤ -->
<div id="controls">
    <label>Page: <input type="number" id="page" value="0" min="0" /></label>
    <label>Size: <input type="number" id="size" value="10" min="1" /></label>
    <button onclick="loadCategories()">ğŸ” ì¡°íšŒ</button>
</div>

<div id="categoryCount" style="margin-top: 10px; font-weight: bold;"></div>

<!-- ì¹´í…Œê³ ë¦¬ í…Œì´ë¸” -->
<table>
    <thead>
    <tr>
        <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"/></th>
        <th>No</th>
        <th>PK</th>
        <th>ì´ë¦„</th>
        <th>ìƒìœ„ PK</th>
        <th>ë ˆë²¨</th>
        <th>ì‚¬ìš©</th>
        <th>ì‚­ì œ</th>
        <th>ğŸ”</th>
    </tr>
    </thead>
    <tbody id="categoryTableBody"></tbody>
</table>

<button onclick="submitUpdates()">ğŸ’¾ ìˆ˜ì • ì €ì¥</button>
<button onclick="deleteSelectedCategories()">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>

<!-- ìƒì„± í¼ -->
<div id="createForm">
    <h3>â• ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
    <form onsubmit="createCategory(event)">
        <label>ì´ë¦„: <input type="text" id="newName" required /></label><br/>
        <label>ìƒìœ„ ì¹´í…Œê³ ë¦¬:
            <select id="newParent">
                <option value="">-- ì—†ìŒ (ìµœìƒìœ„) --</option>
            </select>
        </label><br/>
        <label>ë ˆë²¨: <input type="number" id="newLevel" min="0" required /></label><br/>
        <label>ì‚¬ìš© ì—¬ë¶€:
            <select id="newUseYn">
                <option value="Y">Y</option>
                <option value="N">N</option>
            </select>
        </label>
        <label>ì‚­ì œ ì—¬ë¶€:
            <select id="newDeleteYn">
                <option value="N">N</option>
                <option value="Y">Y</option>
            </select>
        </label><br/>
        <button type="submit">ğŸ“Œ ìƒì„±</button>
    </form>
</div>

<!-- JS -->
<script>
    async function loadCategories() {
        const page = document.getElementById("page").value;
        const size = document.getElementById("size").value;

        try {
            const res = await fetch(`/api/admin/category?page=${page}&size=${size}`);
            const data = await res.json();
            renderCategoryTable(data);
            loadParentCategoryOptions(data.content);
        } catch (err) {
            console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            alert("âŒ ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        }
    }

    function renderCategoryTable(data) {
    const tbody = document.getElementById("categoryTableBody");
    tbody.innerHTML = "";

    const page = parseInt(document.getElementById("page").value);
    const size = parseInt(document.getElementById("size").value);

    data.content.forEach((category, index) => {
        const isDeleted = category.deleteYn === "Y";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td><input type="checkbox" class="delete-checkbox" data-id="${category.categoryPk}" ${isDeleted ? "disabled" : ""}></td>
            <td>${page * size + index + 1}</td>
            <td>${category.categoryPk}</td>
            <td><input class="edit-name" data-id="${category.categoryPk}" value="${category.categoryName}" ${isDeleted ? "disabled" : ""}/></td>
            <td><input class="edit-parent" value="${category.parentPk ?? ''}" ${isDeleted ? "disabled" : ""}/></td>
            <td><input class="edit-level" type="number" value="${category.level}" ${isDeleted ? "disabled" : ""}/></td>
            <td>
                <select class="edit-useYn" ${isDeleted ? "disabled" : ""}>
                    <option value="Y" ${category.useYn === "Y" ? "selected" : ""}>Y</option>
                    <option value="N" ${category.useYn === "N" ? "selected" : ""}>N</option>
                </select>
            </td>
            <td>
                <select class="edit-deleteYn">
                    <option value="N" ${category.deleteYn === "N" ? "selected" : ""}>N</option>
                    <option value="Y" ${category.deleteYn === "Y" ? "selected" : ""}>Y</option>
                </select>
            </td>
            <td><button onclick="viewDetail(${category.categoryPk})" ${isDeleted ? "disabled" : ""}>ğŸ”</button></td>
        `;
        tbody.appendChild(row);
    });

        document.getElementById("categoryCount").textContent = `ì´ ${data.totalElements}ê°œ`;
    }



    function loadParentCategoryOptions(categories) {
        const parentSelect = document.getElementById("newParent");
        parentSelect.innerHTML = `<option value="">-- ì—†ìŒ (ìµœìƒìœ„) --</option>`;
        categories.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.categoryPk;
            option.textContent = `[${cat.categoryPk}] ${cat.categoryName}`;
            parentSelect.appendChild(option);
        });
    }

    async function createCategory(event) {
        event.preventDefault();

        const confirmCreate = confirm("ìƒˆ ì¹´í…Œê³ ë¦¬ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
        if (!confirmCreate) return;

        const newCategory = {
            categoryName: document.getElementById("newName").value,
            parentPk: document.getElementById("newParent").value || null,
            level: parseInt(document.getElementById("newLevel").value),
            useYn: document.getElementById("newUseYn").value,
            deleteYn: document.getElementById("newDeleteYn").value
        };

        try {
            const res = await fetch("/api/admin/category/create", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newCategory)
            });

            if (!res.ok) throw new Error("ìƒì„± ì‹¤íŒ¨");

            alert("âœ… ìƒì„± ì™„ë£Œ");
            document.querySelector("#createForm form").reset();
            loadCategories();
        } catch (err) {
            console.error(err);
            alert("âŒ ìƒì„± ì‹¤íŒ¨");
        }
    }

    async function submitUpdates() {
        const rows = document.querySelectorAll("#categoryTableBody tr");
        const updatedList = [];

        rows.forEach(row => {
            const cells = row.querySelectorAll("td");
            const categoryPk = parseInt(cells[2].textContent.trim());
            const categoryName = row.querySelector(".edit-name").value.trim();
            const parentPkRaw = row.querySelector(".edit-parent").value.trim();
            const level = parseInt(row.querySelector(".edit-level").value);
            const useYn = row.querySelector(".edit-useYn").value;
            const deleteYn = row.querySelector(".edit-deleteYn").value;

            updatedList.push({
                categoryPk,
                categoryName,
                parentPk: parentPkRaw === "" ? null : parseInt(parentPkRaw),
                level,
                useYn,
                deleteYn
            });
        });

        if (!confirm("ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const res = await fetch("/api/admin/category/update", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedList)
            });

            if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
            alert("âœ… ìˆ˜ì • ì™„ë£Œ");
            loadCategories();
        } catch (err) {
            console.error(err);
            alert("âŒ ìˆ˜ì • ì‹¤íŒ¨");
        }
    }

    function viewDetail(categoryPk) {
        alert(`ğŸ” ìƒì„¸ í™•ì¸:\nì¹´í…Œê³ ë¦¬ PK: ${categoryPk}\nâ€» ìƒì„¸ í˜ì´ì§€ê°€ í•„ìš”í•˜ë©´ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
    }

    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll(".delete-checkbox");
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

    async function deleteSelectedCategories() {
        const checkedBoxes = document.querySelectorAll(".delete-checkbox:checked");
        if (checkedBoxes.length === 0) {
            alert("ì‚­ì œí•  ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!confirm(`${checkedBoxes.length}ê°œì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            return;
        }

        const idsToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.getAttribute("data-id")));

        try {
            const res = await fetch("/api/admin/category/delete", {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(idsToDelete)
            });

            if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");

            alert("âœ… ì‚­ì œ ì™„ë£Œ");
            loadCategories();
        } catch (err) {
            console.error(err);
            alert("âŒ ì‚­ì œ ì‹¤íŒ¨");
        }
    }

    function goHome() {
        window.location.href = "/admin/adminMain.html";
    }

    window.onload = loadCategories;
</script>

</body>
</html>
