<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ“ ìƒí’ˆ ìƒì„¸ ì •ë³´ (ê´€ë¦¬ì)</title>
    <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          max-width: 900px;
          margin: 20px auto;
          padding: 10px;
          background: #fafafa;
          color: #333;
        }
        h1 {
          text-align: center;
          margin-bottom: 20px;
          color: #2c3e50;
        }
        .info-block {
          background: white;
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 0 8px rgba(0,0,0,0.1);
          margin-bottom: 20px;
        }
        .info-row {
          margin-bottom: 10px;
          font-size: 1rem;
        }
        .info-row strong {
          width: 120px;
          display: inline-block;
          color: #34495e;
        }
        .image-slot-container {
          display: flex;
          gap: 12px;
          margin-top: 10px;
          flex-wrap: wrap;
        }
        .image-slot {
          width: 120px;
          height: 120px;
          border: 2px dashed #ccc;
          border-radius: 8px;
          display: flex;
          justify-content: center;
          align-items: center;
          position: relative;
          background: #fff;
          cursor: grab;
        }
        .image-slot.dragging {
          opacity: 0.6;
          border-color: #3498db;
        }
        .image-slot img {
          max-width: 100%;
          max-height: 100%;
          border-radius: 6px;
          object-fit: cover;
          user-select: none;
          pointer-events: none;
        }
        .upload-label {
          font-size: 36px;
          color: #bbb;
          cursor: pointer;
          user-select: none;
        }
        .image-input {
          display: none;
        }
        .delete-btn {
          position: absolute;
          top: 3px;
          right: 3px;
          background: #e74c3c;
          color: white;
          border: none;
          border-radius: 50%;
          width: 22px;
          height: 22px;
          cursor: pointer;
          font-weight: bold;
          line-height: 20px;
          text-align: center;
        }
        form label {
          display: block;
          margin: 12px 0 6px;
          font-weight: 600;
          color: #2c3e50;
        }
        form input[type="text"],
        form input[type="number"],
        form select,
        form textarea {
          width: 100%;
          padding: 8px 10px;
          border-radius: 6px;
          border: 1.5px solid #ccc;
          font-size: 1rem;
          box-sizing: border-box;
          transition: border-color 0.3s ease;
        }
        form input[type="text"]:focus,
        form input[type="number"]:focus,
        form select:focus,
        form textarea:focus {
          border-color: #2980b9;
          outline: none;
        }
        form textarea {
          resize: vertical;
          min-height: 80px;
          font-family: inherit;
        }
        button {
          background: #2980b9;
          color: white;
          border: none;
          border-radius: 6px;
          padding: 10px 18px;
          font-size: 1rem;
          cursor: pointer;
          margin-right: 10px;
          transition: background-color 0.25s ease;
        }
        button:hover {
          background: #1f6391;
        }
        .btn-delete {
          background: #c0392b;
        }
        .btn-delete:hover {
          background: #922b21;
        }
        .button-row {
          margin-top: 20px;
          text-align: center;
        }
        .status-label {
          display: inline-block;
          padding: 4px 10px;
          border-radius: 12px;
          font-weight: 600;
          font-size: 0.9rem;
          color: white;
          margin-left: 8px;
        }
        .status-S { background-color: #27ae60; } /* íŒë§¤ì¤‘ */
        .status-C { background-color: #95a5a6; } /* íŒë§¤ì™„ë£Œ */
        .status-P { background-color: #f39c12; } /* íŒë§¤ë³´ë¥˜ */
    </style>
</head>
<body>
<h1>ğŸ“ ìƒí’ˆ ìƒì„¸ ì •ë³´ (ê´€ë¦¬ì)</h1>
<button onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
<div class="info-block" id="detailView">
    <!-- ìƒì„¸ ì •ë³´ ë³´ì—¬ì§€ëŠ” ê³³ -->
</div>

<form id="editForm" style="display:none;">
    <label for="editTitle">ì œëª©</label>
    <input type="text" id="editTitle" required />

    <label for="editContent">ë‚´ìš©</label>
    <textarea id="editContent" rows="5" required></textarea>

    <label for="editHopePrice">í¬ë§ ê°€ê²© (ì›)</label>
    <input type="number" id="editHopePrice" min="0" required />

    <label for="editLatitude">ìœ„ë„</label>
    <input type="number" id="editLatitude" step="0.000000000000001" required />

    <label for="editLongitude">ê²½ë„</label>
    <input type="number" id="editLongitude" step="0.000000000000001" required />

    <label for="editCategoryPk">ì¹´í…Œê³ ë¦¬</label>
    <select id="editCategoryPk" required></select>

    <label for="editDeleteYn">ì‚­ì œ ì—¬ë¶€</label>
    <select id="editDeleteYn" required>
        <option value="N">N (ì‚­ì œ ì•ˆë¨)</option>
        <option value="Y">Y (ì‚­ì œë¨)</option>
    </select>

    <label>ì´ë¯¸ì§€ (ë“œë˜ê·¸ì•¤ë“œë¡­ìœ¼ë¡œ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥, ìµœëŒ€ 4ì¥)</label>
    <div id="imageSlots" class="image-slot-container"></div>

    <div class="button-row">
        <button type="submit">ğŸ’¾ ì €ì¥</button>
        <button type="button" onclick="cancelEdit()">âœ–ï¸ ì·¨ì†Œ</button>
    </div>
</form>

<div class="button-row" id="actionButtons">
    <button onclick="enableEditMode()">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
    <button onclick="goBack()">ğŸ”™ ëª©ë¡ìœ¼ë¡œ</button>
    <button onclick="confirmDelete()" class="btn-delete">ğŸ—‘ï¸ ì‚­ì œ</button>
</div>

<script>
    let postData = null;
    let currentPostPk = null;
    let currentImageUrls = ["", "", "", ""];
    let newImages = [null, null, null, null];
    let draggedIndex = null;

    async function loadPostDetail() {
      currentPostPk = new URLSearchParams(window.location.search).get("postPk");
      if (!currentPostPk) {
        alert("postPkê°€ URLì— ì—†ìŠµë‹ˆë‹¤!");
        return;
      }

      try {
        const res = await fetch(`/api/admin/sale-post/${currentPostPk}`);
        if (!res.ok) throw new Error("ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        postData = await res.json();

        currentImageUrls = postData.imageUrls.slice(0, 4);
        newImages = [null, null, null, null];

        renderDetailView();
      } catch (e) {
        alert(e.message);
        console.error(e);
      }
    }

    function renderDetailView() {
      const div = document.getElementById("detailView");
      div.innerHTML = `
        <div class="info-row"><strong>ì œëª©:</strong> ${escapeHtml(postData.title)}</div>
        <div class="info-row"><strong>ì‘ì„±ì:</strong> ${escapeHtml(postData.sellerNickname)}</div>
        <div class="info-row"><strong>êµ¬ë§¤ì:</strong> ${postData.buyerNickname ? escapeHtml(postData.buyerNickname) : "ì—†ìŒ"}</div>
        <div class="info-row"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${escapeHtml(postData.categoryName)}</div>
        <div class="info-row"><strong>í¬ë§ ê°€ê²©:</strong> ${postData.hopePrice.toLocaleString()} ì›</div>
        <div class="info-row"><strong>íŒë§¤ ìƒíƒœ:</strong>
          <span class="status-label status-${postData.state}">
            ${stateLabel(postData.state)}
          </span>
        </div>
        <div class="info-row"><strong>ì‚­ì œ ì—¬ë¶€:</strong> ${postData.deleteYn === "Y" ? "ì‚­ì œë¨" : "ì‚­ì œ ì•ˆë¨"}</div>
        <div class="info-row"><strong>ìœ„ë„:</strong> ${postData.latitude}</div>
        <div class="info-row"><strong>ê²½ë„:</strong> ${postData.longitude}</div>
        <div class="info-row"><strong>ë‚´ìš©:</strong><br />${escapeHtml(postData.content).replace(/\n/g, "<br>")}</div>
        <div class="info-row"><strong>ì´ë¯¸ì§€:</strong><br />
          ${postData.imageUrls.length > 0
            ? postData.imageUrls.map(url => `<img src="${url}" alt="ìƒí’ˆ ì´ë¯¸ì§€" style="max-width:100px; margin-right:6px; border-radius:6px;">`).join("")
            : "ì—†ìŒ"}
        </div>
      `;

      // í¼ ìˆ¨ê¸°ê³ , ë²„íŠ¼ ë³´ì´ê²Œ
      document.getElementById("editForm").style.display = "none";
      document.getElementById("actionButtons").style.display = "block";
    }

    function stateLabel(stateCode) {
      switch (stateCode) {
        case "S": return "íŒë§¤ì¤‘";
        case "C": return "íŒë§¤ì™„ë£Œ";
        case "P": return "íŒë§¤ë³´ë¥˜";
        default: return "ì•Œ ìˆ˜ ì—†ìŒ";
      }
    }

  function escapeHtml(text) {
    if (!text) return "";
    return text.replace(/[&<>"']/g, function(m) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m];
    });
  }

  async function enableEditMode() {
    if (!postData) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

    document.getElementById("editForm").style.display = "block";
    document.getElementById("actionButtons").style.display = "none";

    document.getElementById("editTitle").value = postData.title;
    document.getElementById("editContent").value = postData.content;
    document.getElementById("editHopePrice").value = postData.hopePrice;
    document.getElementById("editLatitude").value = postData.latitude || '';
    document.getElementById("editLongitude").value = postData.longitude || '';
    document.getElementById("editDeleteYn").value = postData.deleteYn;

    await loadCategories();
    document.getElementById("editCategoryPk").value = postData.categoryPk;

    renderImageSlots();
  }

  async function loadCategories() {
    try {
      const res = await fetch('/api/admin/sale-post/categories');
      if (!res.ok) throw new Error("ì¹´í…Œê³ ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
      const cats = await res.json();

      const sel = document.getElementById("editCategoryPk");
      sel.innerHTML = "";
      cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.categoryPk;
        opt.textContent = c.categoryName;
        sel.appendChild(opt);
      });
    } catch (e) {
      alert(e.message);
      console.error(e);
    }
  }

  function renderImageSlots() {
    const container = document.getElementById("imageSlots");
    container.innerHTML = "";

    for (let i = 0; i < 4; i++) {
      const slot = document.createElement("div");
      slot.className = "image-slot";
      slot.draggable = true;
      slot.dataset.index = i;

      slot.addEventListener("dragstart", e => {
        draggedIndex = i;
        slot.classList.add("dragging");
      });
      slot.addEventListener("dragend", e => {
        slot.classList.remove("dragging");
      });
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", e => {
        e.preventDefault();
        const targetIndex = Number(e.currentTarget.dataset.index);
        [currentImageUrls[draggedIndex], currentImageUrls[targetIndex]] = [currentImageUrls[targetIndex], currentImageUrls[draggedIndex]];
        [newImages[draggedIndex], newImages[targetIndex]] = [newImages[targetIndex], newImages[draggedIndex]];
        renderImageSlots();
      });

      if (currentImageUrls[i]) {
        const img = document.createElement("img");
        img.src = currentImageUrls[i];
        slot.appendChild(img);
      } else if (newImages[i]) {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(newImages[i]);
        slot.appendChild(img);
      } else {
        const label = document.createElement("label");
        label.className = "upload-label";
        label.textContent = "+";
        label.htmlFor = `upload${i}`;

        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.id = `upload${i}`;
        input.className = "image-input";
        input.addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) {
            currentImageUrls[i] = "";
            newImages[i] = file;
            renderImageSlots();
          }
        });

        slot.appendChild(label);
        slot.appendChild(input);
      }

      if (currentImageUrls[i] || newImages[i]) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "delete-btn";
        btn.textContent = "X";
        btn.addEventListener("click", () => {
          currentImageUrls[i] = "";
          newImages[i] = null;
          renderImageSlots();
        });
        slot.appendChild(btn);
      }

      container.appendChild(slot);
    }
  }

  document.getElementById("editForm").addEventListener("submit", async e => {
    e.preventDefault();

    const title = document.getElementById("editTitle").value.trim();
    const content = document.getElementById("editContent").value.trim();
    const hopePrice = Number(document.getElementById("editHopePrice").value);
    const latitude = Number(document.getElementById("editLatitude").value);
    const longitude = Number(document.getElementById("editLongitude").value);
    const categoryPk = Number(document.getElementById("editCategoryPk").value);
    const deleteYn = document.getElementById("editDeleteYn").value;

    if (!title || !content || isNaN(hopePrice) || isNaN(latitude) || isNaN(longitude) || isNaN(categoryPk)) {
      return alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
    }

    const req = {
      title,
      content,
      hopePrice,
      latitude,
      longitude,
      categoryPk,
      imageUrls: currentImageUrls
    };

    const fd = new FormData();
    fd.append("salePostRequest", new Blob([JSON.stringify(req)], { type: "application/json" }));
    newImages.filter(f => f).forEach(f => fd.append("salePostImages", f));
    fd.append("deleteYn", deleteYn);  // ì—¬ê¸° ì¶”ê°€

    try {
      const res = await fetch(`/api/admin/sale-post/${currentPostPk}`, {
        method: "PUT",
        body: fd
      });
      if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
      alert("âœ… ìˆ˜ì • ì„±ê³µ");
      window.location.reload();
    } catch (err) {
      alert("âŒ ìˆ˜ì • ì‹¤íŒ¨: " + err.message);
    }
  });

  function confirmDelete() {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch(`/api/admin/sale-post/${currentPostPk}`, { method: "DELETE" })
      .then(res => {
        if (res.ok) {
          alert("âœ… ì‚­ì œ ì™„ë£Œ");
          goBack();
        } else {
          alert("âŒ ì‚­ì œ ì‹¤íŒ¨");
        }
      })
      .catch(() => alert("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"));
  }

  function goBack() {
    window.location.href = "/admin/adminSalePost.html";
  }

  function cancelEdit() {
    document.getElementById("editForm").style.display = "none";
    document.getElementById("actionButtons").style.display = "block";
  }

    function goHome() {
  window.location.href = "/admin/adminMain.html";
}

  window.onload = loadPostDetail;
</script>
</body>
</html>
