<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì ì‹ ê³  ê´€ë¦¬</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        padding: 2rem;
        background-color: #f5f6fa;
    }

    h1, h2 {
        color: #2f3640;
    }

    section {
        margin-top: 2rem;
    }

    button {
        margin: 0.3rem;
        padding: 0.5rem 1rem;
        background-color: #273c75;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #40739e;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    th, td {
        border: 1px solid #dcdde1;
        padding: 0.5rem;
        text-align: left;
    }

    th {
        background-color: #f1f2f6;
    }

    tr:hover {
        background-color: #f0f0f0;
    }

    .clickable {
        color: #0097e6;
        cursor: pointer;
        text-decoration: underline;
    }
  </style>
</head>
<body>
<h1>ê´€ë¦¬ì ì‹ ê³  ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
<button onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>

<section>
  <h2>ğŸš« ì°¨ë‹¨ëœ íšŒì› ëª©ë¡</h2>
  <button onclick="fetchBlockedMembers()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <table id="blockedMembersTable">
    <thead>
    <tr><th>ID</th><th>ì´ë©”ì¼</th><th>ë‹‰ë„¤ì„</th><th>ì‹ ê³ ë‚´ì—­</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>ğŸ“Œ ì°¨ë‹¨ëœ ê²Œì‹œê¸€ ëª©ë¡</h2>
  <button onclick="fetchBlockedPosts()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <table id="blockedPostsTable">
    <thead>
    <tr><th>ID</th><th>ì œëª©</th><th>ì‘ì„±ì</th><th>ì‹ ê³ ë‚´ì—­</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>ğŸ“„ ì‹ ê³  ìƒì„¸ ë‚´ì—­</h2>
  <table id="reportDetailsTable">
    <thead>
    <tr><th>ì‹ ê³  ID</th><th>ì‹ ê³ ì</th><th>ì‚¬ìœ </th><th>ì‹ ê³ ëŒ€ìƒ</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<script>
  async function fetchBlockedMembers() {
      try {
          const response = await fetch('/api/report/getAllBlockMember', {
              credentials: 'include'  // â† ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ ëŒ€ì‘
          });

          if (response.status === 401 || response.status === 403) {
              alert("âŒ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
              window.location.href = "/login";  // ë¡œê·¸ì¸ í˜ì´ì§€ ê²½ë¡œ
              return;
          }

          const members = await response.json();
          const tbody = document.querySelector("#blockedMembersTable tbody");
          tbody.innerHTML = "";

          members.forEach(member => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                  <td>${member.memberId}</td>
                  <td>${member.email}</td>
                  <td>${member.nickname}</td>
                  <td><span class="clickable" onclick="fetchMemberReports(${member.memberPk})">ë³´ê¸°</span></td>
              `;
              tbody.appendChild(tr);
          });
      } catch (err) {
          console.error(err);
          alert("ğŸš« ì°¨ë‹¨ëœ íšŒì› ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
  }

  async function fetchMemberReports(memberPk) {
      try {
          const response = await fetch(`/api/report/getBlockMember/${memberPk}`, {
              credentials: 'include'
          });

          if (!response.ok) throw new Error("íšŒì› ì‹ ê³  ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

          const reports = await response.json();
          fillReportDetailsTable(reports);
      } catch (err) {
          console.error(err);
          alert("âŒ íšŒì› ì‹ ê³  ë‚´ì—­ ë¡œë”© ì‹¤íŒ¨");
      }
  }

  async function fetchBlockedPosts() {
      try {
          const response = await fetch('/api/report/getAllBlockPost', {
              credentials: 'include'
          });

          if (!response.ok) throw new Error("ì°¨ë‹¨ëœ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

          const posts = await response.json();
          const tbody = document.querySelector("#blockedPostsTable tbody");
          tbody.innerHTML = "";

          posts.forEach(post => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                  <td>${post.postPk}</td>
                  <td>${post.title}</td>
                  <td>${post.sellerPk.nickname}</td>
                  <td><span class="clickable" onclick="fetchPostReports(${post.postPk})">ë³´ê¸°</span></td>
              `;
              tbody.appendChild(tr);
          });
      } catch (err) {
          console.error(err);
          alert("âŒ ì°¨ë‹¨ëœ ê²Œì‹œê¸€ ë¡œë”© ì‹¤íŒ¨");
      }
  }

  async function fetchPostReports(postPk) {
      try {
          const response = await fetch(`/api/report/getBlockPost/${postPk}`, {
              credentials: 'include'
          });

          if (!response.ok) throw new Error("ê²Œì‹œê¸€ ì‹ ê³  ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

          const reports = await response.json();
          fillReportDetailsTable(reports);
      } catch (err) {
          console.error(err);
          alert("âŒ ê²Œì‹œê¸€ ì‹ ê³  ë‚´ì—­ ë¡œë”© ì‹¤íŒ¨");
      }
  }

  function fillReportDetailsTable(reports) {
      const tbody = document.querySelector("#reportDetailsTable tbody");
      tbody.innerHTML = "";
      reports.forEach(report => {
          const targetId = report.reportedMember ? report.reportedMember.id :
                          report.reportedPost ? report.reportedPost.id : "-";

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${report.reportPk}</td>
              <td>${report.reporter.nickname}</td>
              <td>${report.reportReason}</td>
              <td>${report.reportee.nickname}</td>
          `;
          tbody.appendChild(tr);
      });
  }

  function goHome() {
      window.location.href = "/admin/adminMain.html";
  }
</script>
</body>
</html>
